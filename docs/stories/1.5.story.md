# Story 1.5: Project Management API (CRUD)

## Status

Draft

## Story

**As a** AI Agent Developer,
**I want** to perform full CRUD operations on Projects via the secured REST API,
**so that** I can manage my agent's knowledge projects.

## Acceptance Criteria

1. All Project API endpoints (except OPTIONS) are protected by the JWT authentication dependency from Story 1.4.
2. POST `/api/v1/projects`: Creates a new project, validates input using a Pydantic schema, and returns the created project with 201 status.
3. GET `/api/v1/projects`: Lists all projects for the authenticated user, supporting pagination (skip/limit query parameters).
4. GET `/api/v1/projects/{id}`: Retrieves a single project by its ID, ensuring the user has access (returns 404 if not found).
5. PUT `/api/v1/projects/{id}`: Updates an existing project, validating input and access (returns 404 if not found).
6. DELETE `/api/v1/projects/{id}`: Deletes an existing project, ensuring the user has access (returns 404 if not found, 204 on success).
7. E2E tests are created for all 5 endpoints, verifying functionality, authentication, authorization (basic access), and Pydantic validation error handling.

## Tasks / Subtasks

- [ ] Create Pydantic schemas for API (AC: 2, 5)
  - [ ] Define `ProjectCreate` schema in `src/api/v1/schemas/project.py` with fields: name (required), description (optional), tags (optional) [Source: architecture/rest-api-spec.md]
  - [ ] Define `ProjectUpdate` schema with all fields optional [Source: architecture/rest-api-spec.md]
  - [ ] Define `ProjectResponse` schema with id, name, description, status, tags [Source: architecture/rest-api-spec.md]
  - [ ] Add proper validation rules (e.g., name max length, tag format) [Source: architecture/coding-standards.md]
- [ ] Create Project API router (AC: 1-6)
  - [ ] Create `src/api/v1/routes/projects.py` with APIRouter [Source: architecture/source-tree.md]
  - [ ] Add dependency injection for ProjectRepository using `get_current_user` from Story 1.4 [Source: architecture/coding-standards.md]
  - [ ] Implement POST `/api/v1/projects` endpoint (AC: 2)
    - [ ] Accept ProjectCreate schema, validate with Pydantic
    - [ ] Create Project domain entity from schema
    - [ ] Call repository.create()
    - [ ] Return ProjectResponse with 201 status
    - [ ] Handle validation errors (422)
  - [ ] Implement GET `/api/v1/projects` endpoint (AC: 3)
    - [ ] Accept skip (default 0) and limit (default 100) query params
    - [ ] Call repository.get_all(limit, offset)
    - [ ] Return list of ProjectResponse
  - [ ] Implement GET `/api/v1/projects/{id}` endpoint (AC: 4)
    - [ ] Accept UUID path parameter
    - [ ] Call repository.get_by_id()
    - [ ] Return ProjectResponse or 404 if not found
  - [ ] Implement PUT `/api/v1/projects/{id}` endpoint (AC: 5)
    - [ ] Accept UUID path parameter and ProjectUpdate schema
    - [ ] Fetch existing project, return 404 if not found
    - [ ] Update only provided fields
    - [ ] Call repository.update()
    - [ ] Return updated ProjectResponse
  - [ ] Implement DELETE `/api/v1/projects/{id}` endpoint (AC: 6)
    - [ ] Accept UUID path parameter
    - [ ] Call repository.delete()
    - [ ] Return 204 No Content on success, 404 if not found
- [ ] Register router in main.py (AC: 1)
  - [ ] Import projects router in `src/api/main.py`
  - [ ] Add router with prefix `/api/v1` and tags ["Projects"]
- [ ] E2E tests for all endpoints (AC: 7)
  - [ ] Create `tests/e2e/api/v1/test_projects.py` [Source: architecture/test-strategy-and-standards.md]
  - [ ] Setup fixtures: test client, auth token, cleanup
  - [ ] Test POST /projects with valid data (201, returns project with ID)
  - [ ] Test POST /projects with invalid data (422, validation errors)
  - [ ] Test POST /projects without auth (401)
  - [ ] Test GET /projects with auth (200, returns list)
  - [ ] Test GET /projects with pagination (skip=10, limit=5)
  - [ ] Test GET /projects without auth (401)
  - [ ] Test GET /projects/{id} with valid ID (200, returns project)
  - [ ] Test GET /projects/{id} with invalid ID (404)
  - [ ] Test GET /projects/{id} without auth (401)
  - [ ] Test PUT /projects/{id} with valid data (200, returns updated)
  - [ ] Test PUT /projects/{id} with invalid ID (404)
  - [ ] Test PUT /projects/{id} without auth (401)
  - [ ] Test DELETE /projects/{id} with valid ID (204)
  - [ ] Test DELETE /projects/{id} with invalid ID (404)
  - [ ] Test DELETE /projects/{id} without auth (401)

## Dev Notes

- **Authentication**: All endpoints MUST use `get_current_user` dependency from Story 1.4 to protect routes. [Source: architecture/security.md]
- **Pydantic Schemas**: Define in `src/api/v1/schemas/project.py` following the OpenAPI spec. Use Field() for validation and examples. [Source: architecture/rest-api-spec.md]
- **Status Codes**: POST returns 201, GET/PUT return 200, DELETE returns 204, not found returns 404, validation errors return 422, unauthorized returns 401. [Source: architecture/rest-api-spec.md]
- **Error Handling**: Convert `ProjectNotFoundError` to HTTPException with 404 status. Use FastAPI's built-in validation error handling for 422. [Source: architecture/error-handling-strategy.md]
- **Repository Usage**: Inject ProjectRepository into endpoints (don't instantiate directly). Use dependency injection pattern from Story 1.4. [Source: architecture/coding-standards.md]
- **UUID Handling**: FastAPI automatically validates UUID path parameters. Handle invalid UUIDs gracefully. [Source: architecture/coding-standards.md]
- **Pagination**: Default limit=100, default skip=0. Consider adding max_limit validation (e.g., 1000) to prevent abuse. [Source: architecture/rest-api-spec.md]
- **Type Hints**: All functions MUST include full type hints. Use Response, status for explicit status codes. [Source: architecture/coding-standards.md]

### Testing

- **E2E Tests**: Place in `tests/e2e/api/v1/test_projects.py`. Use httpx.AsyncClient with FastAPI TestClient pattern. [Source: architecture/test-strategy-and-standards.md]
- **Test Client**: Use `with TestClient(app) as client:` or `async with AsyncClient(app=app, base_url="http://test") as ac:`. [Source: architecture/test-strategy-and-standards.md]
- **Authentication Setup**: Create a test user and get JWT token in fixture (can reuse from Story 1.4 tests). [Source: architecture/test-strategy-and-standards.md]
- **Test Isolation**: Each test should create its own project data and clean up after (or use transaction rollback). [Source: architecture/test-strategy-and-standards.md]
- **Coverage Goal**: E2E tests should cover happy path, error cases (404, 422, 401), and edge cases (pagination, empty results). [Source: architecture/test-strategy-and-standards.md]
- **Test Framework**: Use pytest with pytest-asyncio. Follow AAA pattern. [Source: architecture/test-strategy-and-standards.md]
- **Validation Testing**: Test Pydantic validation errors (e.g., missing name, invalid tag format, extra fields). [Source: architecture/test-strategy-and-standards.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | 0.1 | Initial draft created | Scrum Master |

## Dev Agent Record

### Agent Model Used

<to be filled by dev agent>

### Debug Log References

<to be filled by dev agent>

### Completion Notes List

<to be filled by dev agent>

### File List

<to be filled by dev agent>

## QA Results

<to be filled by QA agent>
