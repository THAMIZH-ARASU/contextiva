# Story 1.4: Security & Auth Foundation

## Status

Approved

## Story

**As a** AI Agent Developer,
**I want** a basic JWT token creation and validation system in place,
**so that** I can secure all future API endpoints.

## Acceptance Criteria

1. A security utility module is created to handle JWT token creation (e.g., `create_access_token`) and decoding/validation (NFR2).
2. A basic User domain model (with hashed_password) and UserRepository are created (following the pattern from 1.3).
3. A simple POST `/api/v1/auth/token` endpoint is created that accepts a username/password (for testing) and returns a valid JWT.
4. A FastAPI dependency (get_current_user) is created to protect endpoints, which validates the JWT and returns the user model.
5. Stub files/classes for Role-Based Access Control (RBAC) are created (e.g., in `src/api/dependencies.py`), but the complex logic is deferred (NFR2).

## Tasks / Subtasks

- [ ] Create User domain entity (AC: 2)
  - [ ] Define User class in `src/domain/models/user.py` with attributes: id (UUID), username (str), email (str), hashed_password (str), is_active (bool), roles (list[str]) [Source: architecture/security.md#authentication-authorization]
  - [ ] Add business rules/validation (e.g., username required, email format) [Source: architecture/coding-standards.md#language-specific-guidelines]
  - [ ] Use dataclass or Pydantic BaseModel as appropriate [Source: architecture/coding-standards.md#language-specific-guidelines]

- [ ] Define UserRepository interface (AC: 2)
  - [ ] Create IUserRepository ABC in `src/domain/models/user.py` with methods: create, get_by_id, get_by_username, update, delete [Source: architecture/coding-standards.md#critical-rules]
  - [ ] Use ABC pattern per Clean Architecture [Source: architecture/coding-standards.md#critical-rules]

- [ ] Implement concrete UserRepository (AC: 2)
  - [ ] Create `src/infrastructure/database/repositories/user_repository.py` implementing IUserRepository [Source: architecture/source-tree.md]
  - [ ] Use asyncpg connection pool from `src/shared/infrastructure/database/connection.py` [Source: architecture/source-tree.md]
  - [ ] Implement all CRUD operations using parameterized queries [Source: architecture/coding-standards.md#critical-rules]
  - [ ] Map database rows to User domain entities [Source: architecture/database-schema.md]

- [ ] Create Alembic migration for users table (AC: 2)
  - [ ] Generate migration creating `users` table with columns: id (UUID), username (TEXT UNIQUE), email (TEXT UNIQUE), hashed_password (TEXT), is_active (BOOLEAN DEFAULT true), roles (TEXT[]), created_at, updated_at
  - [ ] Add indexes on username and email for lookup performance
  - [ ] Insert a test user for development (username: "testuser", password hash for "testpass")

- [ ] Create JWT security utility module (AC: 1)
  - [ ] Create `src/shared/utils/security.py` with functions: create_access_token, verify_token [Source: architecture/tech-stack.md, architecture/security.md]
  - [ ] Use python-jose[cryptography] for JWT encoding/decoding [Source: architecture/tech-stack.md]
  - [ ] Use passlib[bcrypt] for password hashing (verify_password, get_password_hash functions) [Source: architecture/tech-stack.md]
  - [ ] Load JWT settings (SECRET_KEY, ALGORITHM, ACCESS_TOKEN_EXPIRE_MINUTES) from `src/shared/config/settings.py` [Source: architecture/security.md#secrets-management]
  - [ ] Add JWT_SECRET_KEY and JWT_ALGORITHM to settings.py and .env.example

- [ ] Create auth endpoint (AC: 3)
  - [ ] Create `src/api/v1/routes/auth.py` with POST `/api/v1/auth/token` endpoint [Source: architecture/rest-api-spec.md]
  - [ ] Accept OAuth2PasswordRequestForm (username, password) as input [Source: architecture/rest-api-spec.md]
  - [ ] Validate credentials using UserRepository and password verification [Source: architecture/security.md]
  - [ ] Return JWT token in response: {"access_token": str, "token_type": "bearer"} [Source: architecture/rest-api-spec.md]
  - [ ] Handle invalid credentials with 401 Unauthorized [Source: architecture/rest-api-spec.md]
  - [ ] Register auth router in `src/api/main.py`

- [ ] Create authentication dependency (AC: 4)
  - [ ] Create `get_current_user` dependency in `src/api/dependencies.py` [Source: architecture/security.md#authentication-authorization]
  - [ ] Use OAuth2PasswordBearer scheme (tokenUrl="/api/v1/auth/token") [Source: architecture/security.md]
  - [ ] Decode and validate JWT token using security.py utilities [Source: architecture/security.md]
  - [ ] Retrieve user from UserRepository using token subject (username) [Source: architecture/security.md]
  - [ ] Raise HTTPException 401 for invalid/expired tokens or inactive users [Source: architecture/security.md]
  - [ ] Return User domain model on success

- [ ] Create RBAC stub infrastructure (AC: 5)
  - [ ] Add `require_role` dependency function in `src/api/dependencies.py` that accepts a list of required roles [Source: architecture/security.md#authentication-authorization]
  - [ ] Implement basic role checking: verify current_user.roles contains at least one required role [Source: architecture/security.md]
  - [ ] Raise HTTPException 403 Forbidden if user lacks required role [Source: architecture/security.md]
  - [ ] Add docstring noting this is a stub and complex RBAC logic is deferred

- [ ] Unit tests for security utilities (AC: 1)
  - [ ] Create `tests/unit/shared/utils/test_security.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Test create_access_token generates valid JWT [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Test verify_token decodes and validates JWT correctly [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Test password hashing and verification [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Test token expiration handling [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Follow AAA pattern [Source: architecture/test-strategy-and-standards.md#unit-tests]

- [ ] Unit tests for User domain model (AC: 2)
  - [ ] Create `tests/unit/domain/models/test_user.py` [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Test business rules and validation (username, email format) [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - [ ] Test entity creation with various attribute combinations [Source: architecture/test-strategy-and-standards.md#unit-tests]

- [ ] Integration tests for UserRepository (AC: 2)
  - [ ] Create `tests/integration/infrastructure/database/repositories/test_user_repository.py` [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Use testcontainers for PostgreSQL (or existing test database) [Source: architecture/test-strategy-and-standards.md#test-infrastructure]
  - [ ] Test all CRUD operations: create, get_by_id, get_by_username, update, delete [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test unique constraints on username and email [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Ensure test isolation with transaction rollback or cleanup [Source: architecture/test-strategy-and-standards.md#test-data-management]

- [ ] Integration tests for auth endpoint (AC: 3)
  - [ ] Create `tests/integration/api/v1/routes/test_auth.py` [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test successful login with valid credentials returns JWT token [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test login with invalid username returns 401 [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test login with invalid password returns 401 [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test returned token can be decoded and contains correct claims [Source: architecture/test-strategy-and-standards.md#integration-tests]

- [ ] Integration tests for authentication dependency (AC: 4)
  - [ ] Test get_current_user with valid token returns user [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test get_current_user with expired token returns 401 [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test get_current_user with malformed token returns 401 [Source: architecture/test-strategy-and-standards.md#integration-tests]
  - [ ] Test get_current_user with inactive user returns 401 [Source: architecture/test-strategy-and-standards.md#integration-tests]

## Dev Notes

### Previous Story Insights
- Story 1.3 established the Project domain model and repository pattern
- Following same Clean Architecture approach: domain entities in `src/domain/models/`, repository interfaces as ABCs, concrete implementations in `src/infrastructure/database/repositories/`
- Using asyncpg connection pool from Story 1.2 for database operations
- Alembic migrations used for schema changes
- Custom exceptions (e.g., UserNotFoundError) should be defined in `src/shared/utils/errors.py`

### User Domain Model
- **Attributes**: id (UUID), username (str), email (str), hashed_password (str), is_active (bool), roles (list[str]) [Source: architecture/security.md#authentication-authorization]
- **Business Rules**: username required, email format validation, roles default to empty list [Source: architecture/coding-standards.md#language-specific-guidelines]
- **Pattern**: Use dataclass with slots for performance, similar to Project entity [Source: architecture/coding-standards.md#language-specific-guidelines]

### Database Schema
- **Table**: `users` with columns: id (UUID PRIMARY KEY), username (TEXT UNIQUE NOT NULL), email (TEXT UNIQUE NOT NULL), hashed_password (TEXT NOT NULL), is_active (BOOLEAN DEFAULT true), roles (TEXT[]), created_at (TIMESTAMPTZ), updated_at (TIMESTAMPTZ)
- **Indexes**: Create indexes on username and email for fast lookup
- **Test Data**: Include a test user in migration for development (username: "testuser", hashed password for "testpass")

### JWT Authentication
- **Library**: python-jose[cryptography] for JWT encoding/decoding [Source: architecture/tech-stack.md]
- **Algorithm**: HS256 (HMAC with SHA-256)
- **Token Structure**: Include claims: sub (username), exp (expiration), iat (issued at) [Source: architecture/security.md#authentication-authorization]
- **Settings**: JWT_SECRET_KEY, JWT_ALGORITHM="HS256", ACCESS_TOKEN_EXPIRE_MINUTES=30 (add to settings.py and .env.example) [Source: architecture/security.md#secrets-management]
- **Security**: NEVER log or print the JWT secret key [Source: architecture/security.md#secrets-management]

### Password Hashing
- **Library**: passlib[bcrypt] for password hashing [Source: architecture/tech-stack.md]
- **Functions**: 
  - `get_password_hash(password: str) -> str`: Hash plaintext password
  - `verify_password(plain_password: str, hashed_password: str) -> bool`: Verify password against hash
- **Storage**: Store ONLY hashed passwords in database, never plaintext [Source: architecture/security.md#data-protection]

### Auth Endpoint
- **Path**: POST `/api/v1/auth/token` [Source: architecture/rest-api-spec.md]
- **Request**: OAuth2PasswordRequestForm (FastAPI dependency) with fields: username, password [Source: architecture/rest-api-spec.md]
- **Response**: {"access_token": "<jwt>", "token_type": "bearer"} [Source: architecture/rest-api-spec.md]
- **Error Handling**: Return 401 with message "Incorrect username or password" for invalid credentials [Source: architecture/rest-api-spec.md#components-responses-unauthorizederror]
- **No Authentication**: This endpoint MUST NOT require authentication (it's how users get tokens) [Source: architecture/security.md#authentication-authorization]

### Authentication Dependency
- **Function**: `get_current_user(token: str = Depends(oauth2_scheme)) -> User` in `src/api/dependencies.py` [Source: architecture/security.md#authentication-authorization]
- **OAuth2 Scheme**: OAuth2PasswordBearer(tokenUrl="/api/v1/auth/token") [Source: architecture/security.md]
- **Validation Flow**:
  1. Extract token from Authorization header (Bearer scheme)
  2. Decode and validate JWT using security.py utilities
  3. Extract username from token's "sub" claim
  4. Retrieve user from UserRepository
  5. Verify user exists and is_active=True
  6. Return User domain model
- **Error Cases**: Raise HTTPException(401, detail="Could not validate credentials") for invalid/expired tokens or inactive users [Source: architecture/security.md]

### RBAC Stub
- **Function**: `require_role(roles: list[str])` dependency factory in `src/api/dependencies.py` [Source: architecture/security.md#authentication-authorization]
- **Implementation**: Basic role checking - verify current_user.roles contains at least one required role [Source: architecture/security.md]
- **Error**: Raise HTTPException(403, detail="Insufficient permissions") if user lacks required role [Source: architecture/security.md]
- **Deferred Logic**: Complex RBAC (hierarchical roles, resource-level permissions) is deferred to future stories [Source: architecture/security.md#authentication-authorization]
- **Usage Example**: `Depends(require_role(["admin", "project_owner"]))` (for future use)

### Repository Pattern
- **Interface**: IUserRepository ABC in `src/domain/models/user.py` [Source: architecture/coding-standards.md#critical-rules]
- **Implementation**: UserRepository in `src/infrastructure/database/repositories/user_repository.py` [Source: architecture/source-tree.md]
- **Methods**: create, get_by_id, get_by_username (new method specific to auth), update, delete
- **Dependencies**: Use asyncpg connection pool from `src/shared/infrastructure/database/connection.py` [Source: architecture/source-tree.md]
- **Error Handling**: Raise UserNotFoundError (custom exception) when user not found [Source: architecture/coding-standards.md#critical-rules]

### File Locations
- **Domain Entity**: `src/domain/models/user.py`
- **Repository Interface**: `src/domain/models/user.py` (IUserRepository ABC)
- **Repository Implementation**: `src/infrastructure/database/repositories/user_repository.py`
- **Security Utilities**: `src/shared/utils/security.py` (JWT and password functions)
- **API Dependencies**: `src/api/dependencies.py` (get_current_user, require_role)
- **Auth Routes**: `src/api/v1/routes/auth.py`
- **Settings**: `src/shared/config/settings.py` (add JWT settings)
- **Migration**: `migration/versions/20251106_03_create_users_table.py`
- **Custom Errors**: `src/shared/utils/errors.py` (add UserNotFoundError, InvalidCredentialsError)

### Testing

#### Unit Tests
- **Security Utilities**: `tests/unit/shared/utils/test_security.py`
  - Test JWT creation and verification
  - Test password hashing and verification
  - Test token expiration
  - Mock datetime for expiration tests
  - Coverage goal: 95%+ [Source: architecture/test-strategy-and-standards.md#unit-tests]
  
- **User Domain Model**: `tests/unit/domain/models/test_user.py`
  - Test entity creation with valid/invalid data
  - Test business rules (username required, email format)
  - Test roles default to empty list
  - Follow AAA pattern (Arrange, Act, Assert) [Source: architecture/test-strategy-and-standards.md#unit-tests]
  - Coverage goal: 95%+ [Source: architecture/test-strategy-and-standards.md#unit-tests]

#### Integration Tests
- **UserRepository**: `tests/integration/infrastructure/database/repositories/test_user_repository.py`
  - Test all CRUD operations against real database
  - Test unique constraints on username and email (should raise IntegrityError)
  - Test get_by_username method
  - Use testcontainers for PostgreSQL or existing test database [Source: architecture/test-strategy-and-standards.md#test-infrastructure]
  - Ensure test isolation with cleanup fixtures [Source: architecture/test-strategy-and-standards.md#test-data-management]
  - Coverage goal: 80%+ [Source: architecture/test-strategy-and-standards.md#integration-tests]

- **Auth Endpoint**: `tests/integration/api/v1/routes/test_auth.py`
  - Test successful login returns valid JWT
  - Test invalid username returns 401
  - Test invalid password returns 401
  - Test inactive user cannot login
  - Verify token structure and claims
  - Use httpx.AsyncClient to test FastAPI app [Source: architecture/test-strategy-and-standards.md#end-to-end-e2e-tests]
  
- **Authentication Dependency**: Tests in same file as auth endpoint or separate
  - Test get_current_user with valid token
  - Test get_current_user with expired token (401)
  - Test get_current_user with malformed token (401)
  - Test get_current_user with inactive user (401)
  - Test get_current_user with non-existent user (401)

#### Test Framework
- **Framework**: pytest with pytest-asyncio for async tests [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Pattern**: AAA (Arrange, Act, Assert) [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Fixtures**: Create fixtures for test user, test database session [Source: architecture/test-strategy-and-standards.md#test-data-management]
- **Isolation**: All integration tests MUST clean up test data after execution [Source: architecture/test-strategy-and-standards.md#test-data-management]

### Technical Constraints
- **Type Hints**: All functions MUST include full type hints and pass MyPy checks [Source: architecture/coding-standards.md#language-specific-guidelines]
- **Async**: Use async def for all I/O operations (database, external API calls) [Source: architecture/coding-standards.md#language-specific-guidelines]
- **Clean Architecture**: Domain layer MUST NOT import from infrastructure or api layers [Source: architecture/coding-standards.md#critical-rules]
- **No Hardcoded Secrets**: All secrets MUST be loaded from environment variables via settings.py [Source: architecture/coding-standards.md#critical-rules]
- **SQL Safety**: Use parameterized queries only, never string concatenation [Source: architecture/coding-standards.md#critical-rules]
- **Custom Exceptions**: Raise specific custom exceptions, not generic Exception [Source: architecture/coding-standards.md#critical-rules]

### Security Considerations
- **Password Storage**: NEVER store plaintext passwords; always hash with bcrypt [Source: architecture/security.md#data-protection]
- **Token Validation**: Validate JWT on every protected request [Source: architecture/security.md#authentication-authorization]
- **Logging**: NEVER log passwords, tokens, or secret keys [Source: architecture/security.md#data-protection]
- **Input Validation**: Validate all inputs using Pydantic schemas [Source: architecture/security.md#input-validation]
- **HTTPS**: Production MUST use HTTPS (handled by deployment) [Source: architecture/security.md#api-security]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-06 | 0.1 | Initial draft created | Scrum Master |
